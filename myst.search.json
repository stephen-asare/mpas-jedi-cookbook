{"version":"1","records":[{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook"},"type":"lvl1","url":"/","position":0},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook"},"content":"\n\n\n\n\n\n\n\n\n\nThis Project Pythia Cookbook focuses on analyzing, visualizing, and interpreting MPAS model output on the unstructured voronoi mesh, as well as exploring MPAS-JEDI data assimilation results in both the model and observation spaces.\n\nDisclaimer: This cookbook does NOT cover how to run MPAS or JEDI. Readers are encourage to visit \n\nMPAS or \n\nJEDI websites for more details.","type":"content","url":"/","position":1},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl2":"Motivation"},"type":"lvl2","url":"/#motivation","position":2},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl2":"Motivation"},"content":"NOAA’s next generation Rapid Refresh Forecast System (\n\nRRFS) is built on the MPAS (Model for Prediction Accross Scals) Model and the JEDI (Joint Effort for Data assimilation Integration) system. While both MPAS and JEDI are powerful tools, they can also be complex to use and interpret. This cookbook will demonstrate how to explore MPAS output and MPAS-JEDI analyses directly on the unstructed voronoi mesh using the \n\nUXarray package. It also includes examples for examining JEDI analyses in observation space.","type":"content","url":"/#motivation","position":3},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl2":"Authors"},"type":"lvl2","url":"/#authors","position":4},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl2":"Authors"},"content":"Guoqing Ge (CIRES/NOAA GSL)\n\nOrhan Eroglu (NSF NCAR)\n\nYan Pan (Duke University)\n\nHaidao Lin (NOAA/GSL)\n\nStephen Asare (Florida State University)\n\nAltug Karakurt (University of Colorado, Boulder)\n\nPhilip Chmielowiec (NSF NCAR)","type":"content","url":"/#authors","position":5},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Contributors","lvl2":"Authors"},"type":"lvl3","url":"/#contributors","position":6},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Contributors","lvl2":"Authors"},"content":"","type":"content","url":"/#contributors","position":7},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl2":"Structure"},"type":"lvl2","url":"/#structure","position":8},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl2":"Structure"},"content":"This cookbook is broken into three sections:\n\nIntroduction\n\nMPAS(regional) Analysis and Visualization\n\nJEDI(MPAS) Analysis and Visulization","type":"content","url":"/#structure","position":9},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Section 1. Introduction","lvl2":"Structure"},"type":"lvl3","url":"/#section-1-introduction","position":10},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Section 1. Introduction","lvl2":"Structure"},"content":"The introduction part will provide a quick overview about MPAS, JEDI and RRFS(v2).","type":"content","url":"/#section-1-introduction","position":11},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Section 2. MPAS (regional) Analysis and Visualization","lvl2":"Structure"},"type":"lvl3","url":"/#section-2-mpas-regional-analysis-and-visualization","position":12},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Section 2. MPAS (regional) Analysis and Visualization","lvl2":"Structure"},"content":"This part will demonstrate how to make basic and advanced MPAS analysis and visulazation using UXarray.","type":"content","url":"/#section-2-mpas-regional-analysis-and-visualization","position":13},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Section 3. MPAS-JEDI Analysis and Visualization","lvl2":"Structure"},"type":"lvl3","url":"/#section-3-mpas-jedi-analysis-and-visualization","position":14},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Section 3. MPAS-JEDI Analysis and Visualization","lvl2":"Structure"},"content":"This part will demonstrate how to explore MPAS-JEDI data assimilation results in both the model and observation spaces.","type":"content","url":"/#section-3-mpas-jedi-analysis-and-visualization","position":15},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl2":"Running the Notebooks"},"type":"lvl2","url":"/#running-the-notebooks","position":16},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl2":"Running the Notebooks"},"content":"You can either run the notebook using \n\nBinder or on your local machine.","type":"content","url":"/#running-the-notebooks","position":17},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Running on Binder","lvl2":"Running the Notebooks"},"type":"lvl3","url":"/#running-on-binder","position":18},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Running on Binder","lvl2":"Running the Notebooks"},"content":"The simplest way to interact with a Jupyter Notebook is through \n\nBinder, which enables the execution of a \n\nJupyter Book in the cloud. All you need to know is how to launch a Pythia Cookbooks chapter via Binder. Simply navigate your mouse to the top right corner of the book chapter you are viewing and click on the rocket ship icon, and be sure to select “launch Binder”. After a moment you should be presented with a notebook that you can interact with. I.e. you’ll be able to execute and even change the example programs. You’ll see that the code cells have no output at first, until you execute them by pressing Shift+Enter. Complete details on how to interact with a live Jupyter notebook are described in \n\nGetting Started with Jupyter.\n\nNote, not all Cookbook chapters are executable. If you do not see the rocket ship icon, such as on this page, you are not viewing an executable book chapter.","type":"content","url":"/#running-on-binder","position":19},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Running on Your Own Machine","lvl2":"Running the Notebooks"},"type":"lvl3","url":"/#running-on-your-own-machine","position":20},{"hierarchy":{"lvl1":"MPAS+JEDI Cookbook","lvl3":"Running on Your Own Machine","lvl2":"Running the Notebooks"},"content":"If you are interested in running this material locally on your computer, you will need to follow this workflow:\n\nClone the https://github.com/ProjectPythia/mpas-jedi-cookbook repository: git clone https://github.com/ProjectPythia/mpas-jedi-cookbook\n\nMove into the mpas-jedi-cookbook directorycd mpas-jedi-cookbook\n\nCreate and activate your conda environment from the environment.yml fileconda env create -f environment.yml\nconda activate mpas-jedi-cookbook\n\nMove into the notebooks directory and start up Jupyterlabcd notebooks/\njupyter lab","type":"content","url":"/#running-on-your-own-machine","position":21},{"hierarchy":{"lvl1":"How to Cite This Cookbook"},"type":"lvl1","url":"/notebooks/how-to-cite","position":0},{"hierarchy":{"lvl1":"How to Cite This Cookbook"},"content":"The material in this Project Pythia Cookbook is licensed for free and open consumption and reuse. All code is served under \n\nApache 2.0, while all non-code content is licensed under \n\nCreative Commons BY 4.0 (CC BY 4.0). Effectively, this means you are free to share and adapt this material so long as you give appropriate credit to the Cookbook authors and the Project Pythia community.\n\nThe source code for the book is \n\nreleased on GitHub and archived on Zenodo. This DOI will always resolve to the latest release of the book source:\n\n","type":"content","url":"/notebooks/how-to-cite","position":1},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space"},"type":"lvl1","url":"/notebooks/jedi-mpas","position":0},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space"},"content":"","type":"content","url":"/notebooks/jedi-mpas","position":1},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"In this section, you’ll learn:"},"type":"lvl3","url":"/notebooks/jedi-mpas#in-this-section-youll-learn","position":2},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"In this section, you’ll learn:"},"content":"Utilizing UXarry to compute analysis increments, visualize increments in horizontal and vertical cross sections\n### Related Documentation\n\n* [URL title](URL)\n* \n","type":"content","url":"/notebooks/jedi-mpas#in-this-section-youll-learn","position":3},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Prerequisites"},"type":"lvl3","url":"/notebooks/jedi-mpas#prerequisites","position":4},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\nAtmospheric Data Assimilation\n\nHelpful\n\n\n\nTime to learn: 10 minutesReaders may check \n\npyDAmonitor for more information\n\n","type":"content","url":"/notebooks/jedi-mpas#prerequisites","position":5},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Import packages"},"type":"lvl2","url":"/notebooks/jedi-mpas#import-packages","position":6},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Import packages"},"content":"\n\n%%time \n\n# autoload external python modules if they changed\n%load_ext autoreload\n%autoreload 2\n\n# add ../funcs to the current path\nimport sys, os\nsys.path.append(os.path.join(os.getcwd(), \"..\")) \n\n# import modules\nimport warnings\nimport math\n\nimport cartopy.crs as ccrs\nimport geoviews as gv\nimport geoviews.feature as gf\nimport holoviews as hv\nimport hvplot.xarray\nfrom holoviews import opts\nimport matplotlib as mpl\nimport matplotlib.pyplot as plt\nfrom matplotlib.colors import ListedColormap\n\nimport s3fs\n\nimport geopandas as gp\nimport numpy as np\nimport uxarray as ux\nimport xarray as xr\n\n","type":"content","url":"/notebooks/jedi-mpas#import-packages","position":7},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Configure visualization tools"},"type":"lvl2","url":"/notebooks/jedi-mpas#configure-visualization-tools","position":8},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Configure visualization tools"},"content":"\n\nhv.extension(\"bokeh\")\n# hv.extension(\"matplotlib\")\n\n# common border lines\ncoast_lines = gf.coastline(projection=ccrs.PlateCarree(), line_width=1, scale=\"50m\")\nstate_lines = gf.states(projection=ccrs.PlateCarree(), line_width=1, line_color='gray', scale=\"50m\")\n\n","type":"content","url":"/notebooks/jedi-mpas#configure-visualization-tools","position":9},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl2","url":"/notebooks/jedi-mpas#retrieve-load-mpas-jedi-data","position":10},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"The example MPAS/JEDI data are stored at \n\njetstream2. We need to retreive those data first.There are two ways to retrieve MPAS data:\n\nDownload all example data from JetStream2 to local and them load them locally. This approach allows downloading the data once per machine and reuse it in notebooks.\n\nStream the JetStream2 S3 objects on demand. In this case, each notebook (including restarting a notebook) will retrieve the required data separately as needed.\n\n# choose the data_load_method, check the above cell for details. Default to method 1, i.e. download once and reuse it in multiple notebooks\ndata_load_method = 2  # 1 or 2\n\n","type":"content","url":"/notebooks/jedi-mpas#retrieve-load-mpas-jedi-data","position":11},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Method 1: Download all example data once and reuse it in mulptile notebooks","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/jedi-mpas#method-1-download-all-example-data-once-and-reuse-it-in-mulptile-notebooks","position":12},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Method 1: Download all example data once and reuse it in mulptile notebooks","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\n%%time\nlocal_dir=\"/tmp\"\n\nif data_load_method == 1 and not os.path.exists(local_dir + \"/conus12km/bkg/mpasout.2024-05-06_01.00.00.nc\"):\n    jetstream_url = 'https://js2.jetstream-cloud.org:8001/'\n    fs = s3fs.S3FileSystem(anon=True, asynchronous=False,client_kwargs=dict(endpoint_url=jetstream_url))\n    conus12_path = 's3://pythia/mpas/conus12km'\n    fs.get(conus12_path, local_dir, recursive=True)\n    print(\"Data downloading completed\")\nelse:\n    print(\"Skip..., either data is available in local or data_load_method is NOT 1\")\n\n# Set file path\nif data_load_method == 1:\n    grid_file = local_dir + \"/conus12km/conus12km.invariant.nc_L60_GFS\"\n    ana_file = local_dir + \"/conus12km/bkg/mpasout.2024-05-06_01.00.00.nc\"\n    bkg_file = local_dir + \"/conus12km/ana/mpasout.2024-05-06_01.00.00.nc\"\n\n","type":"content","url":"/notebooks/jedi-mpas#method-1-download-all-example-data-once-and-reuse-it-in-mulptile-notebooks","position":13},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Method 2: Stream the JetStream2 S3 objects on demand","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/jedi-mpas#method-2-stream-the-jetstream2-s3-objects-on-demand","position":14},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Method 2: Stream the JetStream2 S3 objects on demand","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\n%%time\nif data_load_method == 2:\n    jetstream_url = 'https://js2.jetstream-cloud.org:8001/'\n    fs = s3fs.S3FileSystem(anon=True, asynchronous=False,client_kwargs=dict(endpoint_url=jetstream_url))\n    conus12_path = 's3://pythia/mpas/conus12km'\n    \n    grid_url=f\"{conus12_path}/conus12km.invariant.nc_L60_GFS\"\n    bkg_url=f\"{conus12_path}/bkg/mpasout.2024-05-06_01.00.00.nc\"\n    ana_url=f\"{conus12_path}/ana/mpasout.2024-05-06_01.00.00.nc\"\n    \n    grid_file = fs.open(grid_url)\n    ana_file = fs.open(ana_url)\n    bkg_file = fs.open(bkg_url)\nelse:\n    print(\"Skip..., data_load_method is NOT 2\")\n\nWarning\n\nDepending on the network conditions, loading the data can take a few minutes.\n\n","type":"content","url":"/notebooks/jedi-mpas#method-2-stream-the-jetstream2-s3-objects-on-demand","position":15},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Loading the data into UXarray datasets","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/jedi-mpas#loading-the-data-into-uxarray-datasets","position":16},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Loading the data into UXarray datasets","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"We use the UXarray data structures for working with the data. This package supports data defined over unstructured grid and provides utilities for modifying and visualizing it. The available fucntionality are discussed in \n\nUxDataset documentation.\n\nuxds_a = ux.open_dataset(grid_file, ana_file)\nuxds_b = ux.open_dataset(grid_file, bkg_file)\n\n","type":"content","url":"/notebooks/jedi-mpas#loading-the-data-into-uxarray-datasets","position":17},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Compute the analysis increments from the JEDI data assimilation"},"type":"lvl2","url":"/notebooks/jedi-mpas#compute-the-analysis-increments-from-the-jedi-data-assimilation","position":18},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Compute the analysis increments from the JEDI data assimilation"},"content":"JEDI updates the background atmospheric state (uxds_b) with observation innovations and gets a new atmospheric state called analysis (uxds_a).The difference of uxds_a - uxds_b is called “analysis increments”\n\nvar_name = \"theta\"\nuxdiff0 = uxds_a[var_name] - uxds_b[var_name]\nuxvar = uxdiff0\n\n","type":"content","url":"/notebooks/jedi-mpas#compute-the-analysis-increments-from-the-jedi-data-assimilation","position":19},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Horizontal cross sections of analysis increments at different vertical levels"},"type":"lvl2","url":"/notebooks/jedi-mpas#horizontal-cross-sections-of-analysis-increments-at-different-vertical-levels","position":20},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Horizontal cross sections of analysis increments at different vertical levels"},"content":"\n\n","type":"content","url":"/notebooks/jedi-mpas#horizontal-cross-sections-of-analysis-increments-at-different-vertical-levels","position":21},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"define hcross_contour(..) and customize contour levels and color maps","lvl2":"Horizontal cross sections of analysis increments at different vertical levels"},"type":"lvl3","url":"/notebooks/jedi-mpas#define-hcross-contour-and-customize-contour-levels-and-color-maps","position":22},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"define hcross_contour(..) and customize contour levels and color maps","lvl2":"Horizontal cross sections of analysis increments at different vertical levels"},"content":"\n\n# contour horizontal cross sections\ndef hcross_contour(ux_hcross, title, cmin=None, cmax=None, width=800, height=500, clevs=20, cmap=\"coolwarm\", \n                   symmetric_cmap=False, colorbar=True):\n    # Get min and max\n    amin = ux_hcross.min().item()\n    amax = ux_hcross.max().item()\n    title += f\" min={amin:.1f} max={amax:.1f}\"\n    cmin = math.floor(amin) if cmin is None else cmin\n    cmax = math.ceil(amax) if cmax is None else cmax        \n    if symmetric_cmap:  # to get a symmetric color map when cmin < 0, cmax >0\n        cmax = max(abs(cmin), cmax)\n        cmin = -cmax\n\n    if isinstance(cmap, str):\n        cmap = plt.get_cmap(cmap)\n\n    # generate contour plot\n    contour_plot = hv.operation.contours(\n        ux_hcross.plot(),\n        levels=np.linspace(cmin, cmax, num=clevs),  # levels=np.arange(cmin, cmax, 0.5)\n        filled=True\n    ).opts(\n        line_color=None,  # line_width=0.001\n        width=width, height=height,\n        cmap=cmap,\n        clim=(cmin, cmax),\n        colorbar=colorbar,  # cmap=\"inferno\"\n        show_legend=False, tools=['hover'], title=title,\n    )\n\n    return contour_plot\n\n\nfrom matplotlib.colors import ListedColormap, BoundaryNorm, to_rgba\nedges = [-4, -3.5, -3, -2.5, -2, -1.5, -1, -0.5, 0, 0.5, 1.0, 1.5, 2, 2.5, 3, 3.5, 4]\ncolors = [\n    \"#313695\",  # [-4,-3.5]\n    \"#3f72b4\",  # [-3.5,-3]\n    \"#5a9bd5\",  # [-3,-2.5]\n    \"#81bfe0\",  # [-2.5,-2]\n    \"#a6d8e7\",  # [-2,-1.5]\n    \"#cae6ef\",  # [-1.5,-1]\n    \"#e4f1f5\",  # [-1,-0.5]\n    \"#f2f9fc\",  # [-0.5,-0.1]  ← slightly pale blue\n    \"#fcf2f2\",  # [0.1,0.5]     ← slightly pale pink\n    \"#f9d6d4\",  # [0.5,1.0]\n    \"#f5b5b1\",  # [1.0,1.5]\n    \"#ee8a85\",  # [1.5,2.0]\n    \"#e75e5a\",  # [2.0,2.5]\n    \"#d73027\",  # [2.5,3.0]\n    \"#a50026\",  # [3.0,3.5]\n    \"#67001f\",   # [3.5,4.0]\n]\ncmap = ListedColormap(colors)\n\n\n","type":"content","url":"/notebooks/jedi-mpas#define-hcross-contour-and-customize-contour-levels-and-color-maps","position":23},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"plot analysis increments at different vertical levels","lvl2":"Horizontal cross sections of analysis increments at different vertical levels"},"type":"lvl3","url":"/notebooks/jedi-mpas#plot-analysis-increments-at-different-vertical-levels","position":24},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"plot analysis increments at different vertical levels","lvl2":"Horizontal cross sections of analysis increments at different vertical levels"},"content":"\n\n%%time\n\nnt=0  # time dimension\nplot_levels = [0, 19, 29, 39, 42, 49, 58]  # [0, 29, 42]  # [0, 19, 29, 39, 49, 58]\n\nzero_shift = 0.0\n\nplots = []\nfor lev in plot_levels:\n    dat = uxvar.isel(Time=nt, nVertLevels=lev)\n    tmp = hcross_contour(\n        dat.where((dat > 0.1) | (dat < -0.1)),\n        title=f'lev={lev}',\n        cmap=cmap,\n        colorbar=True,\n        cmax=4,\n        cmin=-4\n    ) \n    \n    plots.append(tmp * coast_lines * state_lines)\nfrom IPython.display import display, Markdown\n\ndisplay(Markdown(\n    r\"**Small increments** $\\left[ -0.1 \\ \\text{to} \\ 0.1 \\right]$ **neglected**  <br>\"\n    r\"Indicated in white spaces\"\n))\nfor p in plots:\n   display(p)\n\n","type":"content","url":"/notebooks/jedi-mpas#plot-analysis-increments-at-different-vertical-levels","position":25},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Zoomed into Colorado using the subset capability","lvl2":"Horizontal cross sections of analysis increments at different vertical levels"},"type":"lvl3","url":"/notebooks/jedi-mpas#zoomed-into-colorado-using-the-subset-capability","position":26},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Zoomed into Colorado using the subset capability","lvl2":"Horizontal cross sections of analysis increments at different vertical levels"},"content":"\n\n%%time\n\nlon_center = -105.03\nlat_center = 39.0\nlon_incr = 5 # degree\nlat_incr = 3 # degree\nlon_bounds = (lon_center - lon_incr, lon_center + lon_incr)\nlat_bounds = (lat_center - lat_incr, lat_center + lat_incr)\n\n### subset to a small domain\nuxdiff1 = uxdiff0.subset.bounding_box(lon_bounds, lat_bounds,)\nuxvar = uxdiff1\n\n\nnt=0  # time dimension\nplot_levels = [0, 29, 42]  # [0, 19, 29, 39, 49, 58]\n\nplots = []\nfor lev in plot_levels:\n    tmp = hcross_contour(uxvar.isel(Time=nt, nVertLevels=lev), title=f'lev={lev}', width=700, height=500)  # for the subdomain\n    \n    # overlay state_lines\n    plots.append(tmp * coast_lines * state_lines)  \n\n# each plot has its own toolbar, which facilitates controlling each plot individually\nfor p in plots:\n   display(p)\n\n","type":"content","url":"/notebooks/jedi-mpas#zoomed-into-colorado-using-the-subset-capability","position":27},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Vertical cross sections of analysis increments along an arbitary line (Great Circle Arc, GCA), a constnat laitude/longigutde"},"type":"lvl2","url":"/notebooks/jedi-mpas#vertical-cross-sections-of-analysis-increments-along-an-arbitary-line-great-circle-arc-gca-a-constnat-laitude-longigutde","position":28},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl2":"Vertical cross sections of analysis increments along an arbitary line (Great Circle Arc, GCA), a constnat laitude/longigutde"},"content":"\n\n","type":"content","url":"/notebooks/jedi-mpas#vertical-cross-sections-of-analysis-increments-along-an-arbitary-line-great-circle-arc-gca-a-constnat-laitude-longigutde","position":29},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Along an arbitary line ( Great Circle Arc, GCA)","lvl2":"Vertical cross sections of analysis increments along an arbitary line (Great Circle Arc, GCA), a constnat laitude/longigutde"},"type":"lvl3","url":"/notebooks/jedi-mpas#along-an-arbitary-line-great-circle-arc-gca","position":30},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Along an arbitary line ( Great Circle Arc, GCA)","lvl2":"Vertical cross sections of analysis increments along an arbitary line (Great Circle Arc, GCA), a constnat laitude/longigutde"},"content":"\n\nstart_point = (-110, 20)\nend_point = (-70, 50)\n\nvar_name = \"theta\"\nuxdiff0 = uxds_a[var_name].isel(Time=0) - uxds_b[var_name].isel(Time=0)\nuxvar = uxdiff0\ncross_section_gca = uxvar.cross_section(start=start_point, end=end_point, steps=100)\n\nhlabelticks = [\n    f\"{abs(lat):.1f}°{'N' if lat >= 0 else 'S'}\\n{abs(lon):.1f}°{'E' if lon >= 0 else 'W'}\"\n    for lat, lon in zip(cross_section_gca['lat'], cross_section_gca['lon'])\n]\n\n%matplotlib inline\nfig= plt.figure(figsize=(8,3))\ngs= fig.add_gridspec(1,1)\nax = fig.add_subplot(gs[0,0])\ncf=ax.contourf(cross_section_gca.transpose(),cmap='coolwarm',extend='both')\ntick_stride = 10\nax.set_xticks(cross_section_gca['steps'][::tick_stride])\nax.set_xticklabels(hlabelticks[::tick_stride])\n\n","type":"content","url":"/notebooks/jedi-mpas#along-an-arbitary-line-great-circle-arc-gca","position":31},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Along a constant longitude","lvl2":"Vertical cross sections of analysis increments along an arbitary line (Great Circle Arc, GCA), a constnat laitude/longigutde"},"type":"lvl3","url":"/notebooks/jedi-mpas#along-a-constant-longitude","position":32},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Along a constant longitude","lvl2":"Vertical cross sections of analysis increments along an arbitary line (Great Circle Arc, GCA), a constnat laitude/longigutde"},"content":"\n\nlon=-83.3\ncross_section = uxvar.cross_section(lon=lon, steps=100)\n\nhlabelticks = [\n    f\"{abs(lat):.1f}°{'N' if lat >= 0 else 'S'}\" for lat in cross_section['lat']\n]\n\n%matplotlib inline\nfig= plt.figure(figsize=(8,3))\ngs= fig.add_gridspec(1,1)\nax = fig.add_subplot(gs[0,0])\ncf=ax.contourf(cross_section.transpose(),cmap='coolwarm',extend='both')\n\nax.set_xticks(cross_section['steps'][::tick_stride])\nax.set_xticklabels(hlabelticks[::tick_stride])\n\n","type":"content","url":"/notebooks/jedi-mpas#along-a-constant-longitude","position":33},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Along a constant latitude","lvl2":"Vertical cross sections of analysis increments along an arbitary line (Great Circle Arc, GCA), a constnat laitude/longigutde"},"type":"lvl3","url":"/notebooks/jedi-mpas#along-a-constant-latitude","position":34},{"hierarchy":{"lvl1":"Visualization of JEDI analysis with UXarray in the model space","lvl3":"Along a constant latitude","lvl2":"Vertical cross sections of analysis increments along an arbitary line (Great Circle Arc, GCA), a constnat laitude/longigutde"},"content":"\n\nlat=42.3\ncross_section = uxvar.cross_section(lat=lat, steps=100)\n\nhlabelticks = [\n    f\"{abs(lon):.1f}°{'E' if lon >= 0 else 'W'}\" for lon in cross_section['lon']\n]\n\n%matplotlib inline\nfig= plt.figure(figsize=(8,3))\ngs= fig.add_gridspec(1,1)\nax = fig.add_subplot(gs[0,0])\ncf=ax.contourf(cross_section.transpose(),cmap='coolwarm',extend='both')\n\nax.set_xticks(cross_section['steps'][::tick_stride])\nax.set_xticklabels(hlabelticks[::tick_stride])","type":"content","url":"/notebooks/jedi-mpas#along-a-constant-latitude","position":35},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space"},"type":"lvl1","url":"/notebooks/jedi-obsspace","position":0},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space"},"content":"","type":"content","url":"/notebooks/jedi-obsspace","position":1},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"In this section, you’ll learn:"},"type":"lvl4","url":"/notebooks/jedi-obsspace#in-this-section-youll-learn","position":2},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"In this section, you’ll learn:"},"content":"Generate data assimilation statistics and visualize them in the observation space\n### Related Documentation\n\n* [URL title](URL)\n* \n","type":"content","url":"/notebooks/jedi-obsspace#in-this-section-youll-learn","position":3},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Prerequisites"},"type":"lvl4","url":"/notebooks/jedi-obsspace#prerequisites","position":4},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\nAtmospheric Data Assimilation\n\nHelpful\n\n\n\nTime to learn: 10 minutesReaders may check \n\npyDAmonitor for more information\n\n","type":"content","url":"/notebooks/jedi-obsspace#prerequisites","position":5},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl2":"Work with obsSpace"},"type":"lvl2","url":"/notebooks/jedi-obsspace#work-with-obsspace","position":6},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl2":"Work with obsSpace"},"content":"\n\nJEDI or GSI generates observation space diagnostic files, which contains original observation information, hofx (H(x), i.e. model counter-parts at the observation locations), OMB (observation minus background), OMA as well as other information.\n\nThis notebook covers how to deal with JEDI diganostic files (which are also called output ioda files). We call them jdiag files here.\n\n","type":"content","url":"/notebooks/jedi-obsspace#work-with-obsspace","position":7},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Import packages","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#import-packages","position":8},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Import packages","lvl2":"Work with obsSpace"},"content":"\n\n%%time \n\n# autoload external python modules if they changed\n%load_ext autoreload\n%autoreload 2\n\n# import modules\nimport warnings\nimport math\nimport sys\nimport os\n\nimport cartopy.crs as ccrs\nimport geoviews as gv\nimport geoviews.feature as gf\nimport holoviews as hv\nimport hvplot.xarray\nfrom holoviews import opts\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as mticker\nimport matplotlib.colors as colors\nfrom netCDF4 import Dataset\n\n\nimport s3fs\nimport seaborn as sns  # seaborn handles NaN values automatically\n\nimport geopandas as gp\nimport numpy as np\nimport uxarray as ux\nimport xarray as xr\nimport pandas as pd\n\nfrom obsSpace import obsSpace, fit_rate, query_data, to_dataframe, query_dataset, query_obj\n\n","type":"content","url":"/notebooks/jedi-obsspace#import-packages","position":9},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Retrieve JEDI data","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#retrieve-jedi-data","position":10},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Retrieve JEDI data","lvl2":"Work with obsSpace"},"content":"The example JEDI data are stored at \n\njetstream2. We need to retreive those data first.\n\n%%time\nlocal_dir=\"/tmp/conus12km\"\nos.makedirs(local_dir, exist_ok=True)\n\nif not os.path.exists(local_dir + \"/jdiag_cris-fsr_n20.nc\"):\n    jetstream_url = 'https://js2.jetstream-cloud.org:8001/'\n    fs = s3fs.S3FileSystem(anon=True, asynchronous=False,client_kwargs=dict(endpoint_url=jetstream_url))\n    conus12_path = 's3://pythia/mpas/conus12km'\n    fs.get(conus12_path + \"/jdiag_aircar_t133.nc\", local_dir+\"/jdiag_aircar_t133.nc\")\n    fs.get(conus12_path + \"/jdiag_aircar_q133.nc\", local_dir+\"/jdiag_aircar_q133.nc\")\n    fs.get(conus12_path + \"/jdiag_aircar_uv233.nc\", local_dir+\"/jdiag_aircar_uv233.nc\")\n    fs.get(conus12_path + \"/jdiag_cris-fsr_n20.nc\", local_dir+\"/jdiag_cris-fsr_n20.nc\")\n    print(\"Data downloading completed\")\nelse:\n    print(\"Skip..., data is available in local\")\n\njdiag_file=local_dir+\"/jdiag_aircar_t133.nc\"\n\n","type":"content","url":"/notebooks/jedi-obsspace#retrieve-jedi-data","position":11},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Use NetCDF4 to read jdiag files","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#use-netcdf4-to-read-jdiag-files","position":12},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Use NetCDF4 to read jdiag files","lvl2":"Work with obsSpace"},"content":"\n\ndataset=Dataset(jdiag_file, mode='r')\nquery_dataset(dataset)\n\n","type":"content","url":"/notebooks/jedi-obsspace#use-netcdf4-to-read-jdiag-files","position":13},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Use the obsSpace class to read jdiag files","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#use-the-obsspace-class-to-read-jdiag-files","position":14},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Use the obsSpace class to read jdiag files","lvl2":"Work with obsSpace"},"content":"\n\nFrom the above output, we can see that jdiag (or output ioda file) wraps atmospheric state varaibles under attributes (or groups, such as hofx0, obsError, ObsValue, etc).We provide a Python class obsSpace to access jdiag data in a traditional, intuitive way, such as aircar.t.hofx0, aircar.t.obsError, etc.\n\n# create an `aircar` object using the `obsSpace` class\naircar = obsSpace(jdiag_file)\n\n","type":"content","url":"/notebooks/jedi-obsspace#use-the-obsspace-class-to-read-jdiag-files","position":15},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"check the aircar object","lvl3":"Use the obsSpace class to read jdiag files","lvl2":"Work with obsSpace"},"type":"lvl4","url":"/notebooks/jedi-obsspace#check-the-aircar-object","position":16},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"check the aircar object","lvl3":"Use the obsSpace class to read jdiag files","lvl2":"Work with obsSpace"},"content":"\n\nquery_obj(aircar)\n\nFrom the above output, we can see the aircar object contains t, q, u, v, etc. Since jdiag_aircar_t133.nc only contains temperature observations, only aircar.t has observation diagnostics.\n\n","type":"content","url":"/notebooks/jedi-obsspace#check-the-aircar-object","position":17},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Query temperature data array","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#query-temperature-data-array","position":18},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Query temperature data array","lvl2":"Work with obsSpace"},"content":"\n\nquery_data(aircar.t)\n\n# print out array values\nnp.set_printoptions(threshold=500) # don't print out all array values\nprint(aircar.t.ObsValue)\n\n","type":"content","url":"/notebooks/jedi-obsspace#query-temperature-data-array","position":19},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Convert data array to Pandas DataFrame","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#convert-data-array-to-pandas-dataframe","position":20},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Convert data array to Pandas DataFrame","lvl2":"Work with obsSpace"},"content":"\n\nConverting jdiag data into Pandas DataFrame brings up lots of benefits and we can utilize lots of existing DataFrame capabilities.\n\ndf = to_dataframe(aircar.t)\ndf\n\n","type":"content","url":"/notebooks/jedi-obsspace#convert-data-array-to-pandas-dataframe","position":21},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Plot histograms","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#plot-histograms","position":22},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Plot histograms","lvl2":"Work with obsSpace"},"content":"\n\n","type":"content","url":"/notebooks/jedi-obsspace#plot-histograms","position":23},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Example 1","lvl3":"Plot histograms","lvl2":"Work with obsSpace"},"type":"lvl4","url":"/notebooks/jedi-obsspace#example-1","position":24},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Example 1","lvl3":"Plot histograms","lvl2":"Work with obsSpace"},"content":"\n\n# plot histogram of OmA\n\nplt.figure(figsize=(8, 5))\n#sns.histplot(df[\"oman\"], bins=50, kde=True, color=\"steelblue\")\nsns.histplot(aircar.t.oman, bins=100, kde=True, color=\"steelblue\")\nplt.title(\"Histogram of oman\")\nplt.xlabel(\"oman values\")\nplt.ylabel(\"Density\")\nplt.tight_layout()\nplt.show()\n\n","type":"content","url":"/notebooks/jedi-obsspace#example-1","position":25},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Example 2","lvl3":"Plot histograms","lvl2":"Work with obsSpace"},"type":"lvl4","url":"/notebooks/jedi-obsspace#example-2","position":26},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Example 2","lvl3":"Plot histograms","lvl2":"Work with obsSpace"},"content":"\n\n# overlay OMB and OMA histogram together\n\ndf_long = df[[\"oman\", \"ombg\"]].melt(var_name=\"variable\", value_name=\"value\")\n\nplt.figure(figsize=(8, 5))\nsns.histplot(data=df_long, x=\"value\", hue=\"variable\", bins=50, kde=True, element=\"step\", stat=\"count\")\nplt.title(\"Overlayed Histogram: oman vs ombg\")\nplt.tight_layout()\nplt.show()\n\n","type":"content","url":"/notebooks/jedi-obsspace#example-2","position":27},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Example 3","lvl3":"Plot histograms","lvl2":"Work with obsSpace"},"type":"lvl4","url":"/notebooks/jedi-obsspace#example-3","position":28},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Example 3","lvl3":"Plot histograms","lvl2":"Work with obsSpace"},"content":"\n\n# overlay OMB and OMA histogram together\n\nplt.figure(figsize=(8, 5))\nsns.histplot(df[\"oman\"], bins=100, kde=True, color=\"blue\", label=\"oman\", multiple=\"layer\")\nsns.histplot(df[\"ombg\"], bins=100, kde=True, color=\"red\", label=\"ombg\", multiple=\"layer\")\n\nplt.title(\"Overlayed Histogram: oman vs ombg\")\nplt.xlabel(\"Value\")\nplt.ylabel(\"Frequency\")\nplt.legend()\nplt.tight_layout()\nplt.show()\n\n","type":"content","url":"/notebooks/jedi-obsspace#example-3","position":29},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"plot fitting rate","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#plot-fitting-rate","position":30},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"plot fitting rate","lvl2":"Work with obsSpace"},"content":"\n\nThe rate fitting to observations is an important metric to evaluate data assimilation performance.\nWe don’t want a small fitting rate, which means very little observation impacts on the model forecast.\nWe don’t want a large fitting rate either, which means we fit too close to the observations and the model forecast will crash. Usually, a fitting rate of 20%~30% is expected.\n\n# 1. Filter valid data (both 'oman' and 'ombg' are not NaN)\nvalid_df = df[df[\"oman\"].notna() & df[\"ombg\"].notna()].copy()\nvalid_df = valid_df.dropna(subset=[\"height\"])  # removes any rows in valid_df where height is missing (NaN)\nprint(valid_df[valid_df[\"height\"] < 0][\"height\"])   # negative height\n\ndz = 1000\ngrouped = fit_rate(aircar.t, dz=dz)\n\n# 5. Plot vertical profile of fit_rate vs height\nplt.figure(figsize=(7, 6))\nplt.plot(grouped[\"fit_rate\"], grouped[\"height_bin\"], marker=\"o\", color=\"blue\")\n# plt.axvline(x=0, color=\"gray\", linestyle=\"--\")  # ax vertical line\n\nplt.xlabel(\"Fit Rate (%)\")  # label change\nplt.gca().xaxis.set_major_formatter(plt.FuncFormatter(lambda x, _: f'{x*100:.0f}%'))  # format as %\nplt.ylabel(\"Height Bin (m)\")\nplt.title(\"Vertical Profile of Fit Rate\")\n\n# Fine-tune ticks\nplt.xticks(np.arange(0, 0.25, 0.05))  #, fontsize=12)\nplt.yticks(np.arange(0, 13000, dz))  #, , fontsize=12)\n# Add minor ticks\nfrom matplotlib.ticker import AutoMinorLocator\nplt.gca().xaxis.set_minor_locator(AutoMinorLocator())\nplt.gca().yaxis.set_minor_locator(AutoMinorLocator())\n# plt.grid(which='both', linestyle='--', linewidth=0.5)\nplt.grid(True)\n\nplt.ylim(0, 13000)  # set y-axis from 0 (bottom) to 13,000 (top)\nplt.tight_layout()\nplt.show()\n\nprint(grouped[\"height_bin\"])\n\n","type":"content","url":"/notebooks/jedi-obsspace#plot-fitting-rate","position":31},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"type":"lvl3","url":"/notebooks/jedi-obsspace#plot-satellite-radiance-observations","position":32},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"content":"\n\n","type":"content","url":"/notebooks/jedi-obsspace#plot-satellite-radiance-observations","position":33},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"load satellite data using obsSpace","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"type":"lvl4","url":"/notebooks/jedi-obsspace#load-satellite-data-using-obsspace","position":34},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"load satellite data using obsSpace","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"content":"\n\n%%time\n\nobsCris = obsSpace(local_dir + \"/jdiag_cris-fsr_n20.nc\")\n\n# query the `bt` data array, excluding the metadata starting with `sensorCentralWavenumber_`.  bt=Brightness Temperature\nquery_data(obsCris.bt, meta_exclude=\"sensorCentralWavenumber_\")\n\n# print H(x) values\nprint(obsCris.bt.hofx0)\n\n","type":"content","url":"/notebooks/jedi-obsspace#load-satellite-data-using-obsspace","position":35},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"assemble target obs array","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"type":"lvl4","url":"/notebooks/jedi-obsspace#assemble-target-obs-array","position":36},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"assemble target obs array","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"content":"\n\nncount=0\nidx = []\nidx2 = []\nch=61\nfor n in np.arange(len(obsCris.bt.ombg[:,ch])):\n    #if obsCris.bt.CloudDetectMinResidualIR[n,ch] == 1: \n     if obsCris.bt.ombg[n,ch] > -200 and obsCris.bt.ombg[n,ch] < 200:\n       idx.append(n)\n       ncount = ncount + 1 \n\nlat=obsCris.bt.latitude[idx]\nlon=obsCris.bt.longitude[idx]\nobarray=obsCris.bt.DerivedObsValue[idx,ch]\nprint(lon,lat,obarray)\nprint(ncount)\n\n","type":"content","url":"/notebooks/jedi-obsspace#assemble-target-obs-array","position":37},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"prepare color map","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"type":"lvl4","url":"/notebooks/jedi-obsspace#prepare-color-map","position":38},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"prepare color map","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"content":"\n\ndatmi = np.nanmin(obarray)  # Min of the data\ndatma = np.nanmax(obarray)  # Max of the data\n\n\nimport matplotlib.pyplot as plt\nif np.nanmin(obarray) < 0:\n  cmax = datma\n  cmin = datmi\n  cmax=310\n  cmin=200\n  #cmax=1.0\n  #cmin=-1.0\n  cmap = 'RdBu'\nelse:\n  #cmax = omean+stdev\n  #cmin = np.maximum(omean-stdev, 0.0)\n  cma = datma\n  cmin = datmi\n  cmax=310\n  cmin=200\n  #cmax=1.0\n  #cmin=-1.0\n  cmap = 'RdBu'\n  cmap = 'viridis'\n  cmap = 'jet'\n\n\n\ncmin = 200.\ncmax = 310.\nconus_12km = [-150, -50, 15, 55]\n\ncolor_map = plt.cm.get_cmap(cmap)\nreversed_color_map = color_map.reversed()\nunits = 'K'\n#units = '%'\n\nfig = plt.figure(figsize=(10, 5))\n\n","type":"content","url":"/notebooks/jedi-obsspace#prepare-color-map","position":39},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Make the plot","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"type":"lvl4","url":"/notebooks/jedi-obsspace#make-the-plot","position":40},{"hierarchy":{"lvl1":"Visualization of JEDI analysis in the observation space","lvl4":"Make the plot","lvl3":"Plot satellite radiance observations","lvl2":"Work with obsSpace"},"content":"\n\n# Initialize the plot pointing to the projection\n# ------------------------------------------------\nax = plt.axes(projection=ccrs.PlateCarree(central_longitude=0))\n\n# Plot grid lines\n# ----------------\ngl = ax.gridlines(crs=ccrs.PlateCarree(central_longitude=0), draw_labels=True,\n                  linewidth=1, color='gray', alpha=0.5, linestyle='-')\ngl.top_labels = False\ngl.xlabel_style = {'size': 10, 'color': 'black'}\ngl.ylabel_style = {'size': 10, 'color': 'black'}\ngl.xlocator = mticker.FixedLocator(\n   [-180, -135, -90, -45, 0, 45, 90, 135, 179.9])\nax.set_ylabel(\"Latitude\",  fontsize=7)\nax.set_xlabel(\"Longitude\", fontsize=7)\n\n# Get scatter data\n# ------------------\n#print('obarray = ', obarray)\nprint('min/max obarray = ', min(obarray),max(obarray))\n#sc = ax.scatter(lonData, latData,\nsc = ax.scatter(lon, lat,\n                c=obarray, s=4, linewidth=0,\n                transform=ccrs.PlateCarree(), cmap=cmap, vmin=cmin, vmax = cmax, norm=None, antialiased=True)\n\n\n\n\n# Plot colorbar\n# --------------\ncbar = plt.colorbar(sc, ax=ax, orientation=\"horizontal\", pad=.1, fraction=0.06,ticks=[200, 210, 220, 230, 240, 250, 260, 270, 280, 290, 300, 310])\n#cbar = plt.colorbar(sc, ax=ax, orientation=\"horizontal\", pad=.1, fraction=0.06,ticks=[-3, -2.5, -2, -1.5, -1, -0.5, 0, 0.5, 1.0, 1.5, 2.0, 2.5, 3 ])\n#cbar = plt.colorbar(sc, ax=ax, orientation=\"horizontal\", pad=.1, fraction=0.06,ticks=[0, 10, 20, 20, 40, 50, 60, 70, 80, 90, 100])\ncbar.ax.set_ylabel(units, fontsize=10)\n# Plot globally\n# --------------\n#ax.set_global()\n#ax.set_extent(conus)\nax.set_extent(conus_12km)\n\n# Draw coastlines\n# ----------------\nax.coastlines()\nax.text(0.45, -0.1, 'Longitude', transform=ax.transAxes, ha='left')\nax.text(-0.08, 0.4, 'Latitude', transform=ax.transAxes,\n        rotation='vertical', va='bottom')\n\n#text = f\"Total Count:{datcont:0.0f}, Max/Min/Mean/Std: {datma:0.3f}/{datmi:0.3f}/{omean:0.3f}/{stdev:0.3f} {units}\"\n#print(text)\n#ax.text(0.67, -0.1, text, transform=ax.transAxes, va='bottom', fontsize=6.2)\n\ndpi=150\ngl.top_labels = False\nplt.tight_layout()\n\n# show plot\n# -----------\n# pname='test.png'\n# plt.savefig(pname, dpi=dpi)                          ","type":"content","url":"/notebooks/jedi-obsspace#make-the-plot","position":41},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray"},"type":"lvl1","url":"/notebooks/mpas-advanced","position":0},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray"},"content":"","type":"content","url":"/notebooks/mpas-advanced","position":1},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"In this section, you’ll learn:"},"type":"lvl3","url":"/notebooks/mpas-advanced#in-this-section-youll-learn","position":2},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"In this section, you’ll learn:"},"content":"Utilizing the UXarray package to perform advanced analysis over MPAS data, such as cross-sections and zonal averages, etc.\n\nUsing Matplotlib and hvPlot to visualize analysis.\n### Related Documentation\n\n* [URL title](URL)\n* \n","type":"content","url":"/notebooks/mpas-advanced#in-this-section-youll-learn","position":3},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Prerequisites"},"type":"lvl3","url":"/notebooks/mpas-advanced#prerequisites","position":4},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\nUXarray\n\nNecessary\n\n\n\nSciPy\n\nHelpful\n\n\n\nHoloViews\n\nHelpful\n\n\n\nTime to learn: 15 minutes\n\n","type":"content","url":"/notebooks/mpas-advanced#prerequisites","position":5},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Import packages"},"type":"lvl2","url":"/notebooks/mpas-advanced#import-packages","position":6},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Import packages"},"content":"\n\n%%time \n\n# autoload external python modules if they changed\n%load_ext autoreload\n%autoreload 2\n\n# add ../funcs to the current path\nimport sys, os\nsys.path.append(os.path.join(os.getcwd(), \"..\")) \n\nimport warnings\nimport math\n\nimport cartopy.crs as ccrs\nimport geoviews as gv\nimport geoviews.feature as gf\nimport matplotlib.pyplot as plt\n\nimport s3fs\n\nimport geopandas as gp\nimport numpy as np\nimport uxarray as ux\nimport xarray as xr\n\nUXarray and hvPlot\n\nhvPlot is a high-level API built on HoloViews that provides interactive plots. It is integrated with UXarray with a .hvplot() similar to .plot() in Pandas library, but will produce more interactive figures. Import the relevant packages if you want to use the hvplot API.\n\n%%time \nimport holoviews as hv\nimport hvplot.xarray\nfrom holoviews import opts\nhv.extension(\"bokeh\")\n\n","type":"content","url":"/notebooks/mpas-advanced#import-packages","position":7},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Configure visualization tools"},"type":"lvl2","url":"/notebooks/mpas-advanced#configure-visualization-tools","position":8},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Configure visualization tools"},"content":"\n\n# common border lines\ncoast_lines = gf.coastline(projection=ccrs.PlateCarree(), line_width=1, scale=\"50m\")\nstate_lines = gf.states(projection=ccrs.PlateCarree(), line_width=1, line_color='gray', scale=\"50m\")\n\nHint\n\nWe use the unstructured-grid analysis data hosted by the Jetstream2 S3 bucket repository using UXaray. The data is executed by \n\nMPAS over the CONUS (contiguous United States) with a resolution of 12 kilometres, which is stored in the NetCDF format.\n\nFor more information about the UXarray and unstructured grid, please go to \n\nWorking with unstructured grids with UXarray.\n\n","type":"content","url":"/notebooks/mpas-advanced#configure-visualization-tools","position":9},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl2","url":"/notebooks/mpas-advanced#retrieve-load-mpas-jedi-data","position":10},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"The example MPAS/JEDI data are stored at \n\njetstream2. We need to retreive those data first.There are two ways to retrieve MPAS data:\n\nDownload all example data from JetStream2 to local and them load them locally. This approach allows downloading the data once per machine and reuse it in notebooks.\n\nStream the JetStream2 S3 objects on demand. In this case, each notebook (including restarting a notebook) will retrieve the required data separately as needed.\n\n# choose the data_load_method, check the above cell for details. Default to method 2; use 1 if running this on your own machine\ndata_load_method = 2  # 1 or 2\n\n","type":"content","url":"/notebooks/mpas-advanced#retrieve-load-mpas-jedi-data","position":11},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Method 1: Download all example data once and reuse it in mulptile notebooks","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/mpas-advanced#method-1-download-all-example-data-once-and-reuse-it-in-mulptile-notebooks","position":12},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Method 1: Download all example data once and reuse it in mulptile notebooks","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\n%%time\nlocal_dir=\"/tmp\"\n\nif data_load_method == 1 and not os.path.exists(local_dir + \"/conus12km/bkg/mpasout.2024-05-06_01.00.00.nc\"):\n    jetstream_url = 'https://js2.jetstream-cloud.org:8001/'\n    fs = s3fs.S3FileSystem(anon=True, asynchronous=False,client_kwargs=dict(endpoint_url=jetstream_url))\n    conus12_path = 's3://pythia/mpas/conus12km'\n    fs.get(conus12_path, local_dir, recursive=True)\n    print(\"Data downloading completed\")\nelse:\n    print(\"Skip..., either data is available in local or data_load_method is NOT 1\")\n\n# Set file path\nif data_load_method == 1:\n    grid_file = local_dir + \"/conus12km/conus12km.invariant.nc_L60_GFS\"\n    ana_file = local_dir + \"/conus12km/bkg/mpasout.2024-05-06_01.00.00.nc\"\n    bkg_file = local_dir + \"/conus12km/ana/mpasout.2024-05-06_01.00.00.nc\"\n    # jdiag_file = local_dir + \"/conus12km/jdiag_aircar_t133.nc\"  #q133.nc or uv233.nc\n\n","type":"content","url":"/notebooks/mpas-advanced#method-1-download-all-example-data-once-and-reuse-it-in-mulptile-notebooks","position":13},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Method 2: Stream the JetStream2 S3 objects on demand","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/mpas-advanced#method-2-stream-the-jetstream2-s3-objects-on-demand","position":14},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Method 2: Stream the JetStream2 S3 objects on demand","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\n%%time\nif data_load_method == 2:\n    jetstream_url = 'https://js2.jetstream-cloud.org:8001/'\n    fs = s3fs.S3FileSystem(anon=True, asynchronous=False,client_kwargs=dict(endpoint_url=jetstream_url))\n    conus12_path = 's3://pythia/mpas/conus12km'\n    \n    grid_url=f\"{conus12_path}/conus12km.invariant.nc_L60_GFS\"\n    bkg_url=f\"{conus12_path}/bkg/mpasout.2024-05-06_01.00.00.nc\"\n    ana_url=f\"{conus12_path}/ana/mpasout.2024-05-06_01.00.00.nc\"\n    # jdiag_url=f\"{conus12_path}/jdiag_aircar_t133.nc\"\n    \n    grid_file = fs.open(grid_url)\n    ana_file = fs.open(ana_url)\n    bkg_file = fs.open(bkg_url)\n    # jdiag_file = fs.open(jdiag_url)\nelse:\n    print(\"Skip..., data_load_method is NOT 2\")\n\nWarning\n\nDepending on the network conditions, loading the data can take a few minutes.\n\n","type":"content","url":"/notebooks/mpas-advanced#method-2-stream-the-jetstream2-s3-objects-on-demand","position":15},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Loading the data into UXarray datasets","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/mpas-advanced#loading-the-data-into-uxarray-datasets","position":16},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Loading the data into UXarray datasets","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"We use the UXarray data structures for working with the data. This package supports data defined over unstructured grid and provides utilities for modifying and visualizing it. The available fucntionality are discussed in \n\nUxDataset documentation.For more information about the UXarray and unstructured grid, please go to \n\nWorking with unstructured grids with UXarray.\n\nuxds = ux.open_dataset(grid_file, bkg_file)\n\n# We will extract the potential temperature `theta` from the analysis data from MPAS and convert it from Kelvin to Celsius.\nuxvar = uxds['theta'].isel(Time=0) - 273.15   ## Kelvin to Celsius\n\n","type":"content","url":"/notebooks/mpas-advanced#loading-the-data-into-uxarray-datasets","position":17},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"basic information of used dataset","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/mpas-advanced#basic-information-of-used-dataset","position":18},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"basic information of used dataset","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\nmin_lat,max_lat = float(uxvar.uxgrid.face_lat.min()),float(uxvar.uxgrid.face_lat.max())\nmin_lon,max_lon = float(uxvar.uxgrid.face_lon.min()),float(uxvar.uxgrid.face_lon.max())\nprint( f\"The data is over \"+\n      f\"{abs(min_lat):.1f}°{'N' if min_lat >= 0 else 'S'}~{abs(max_lat):.1f}°{'N' if max_lat >= 0 else 'S'}, \"\n      f\"{min_lon:.1f}°{'E' if min_lon >= 0 else 'W'}~{max_lon:.1f}°{'E' if max_lon >= 0 else 'W'}, \"+\n      \"\\n\"+\n     \"with a resolution of {:d} horizontal grids * {:d} vertical levels.\".format(uxvar.shape[-2],uxvar.shape[-1]))\n\n","type":"content","url":"/notebooks/mpas-advanced#basic-information-of-used-dataset","position":19},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Indexing and selecting","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/mpas-advanced#indexing-and-selecting","position":20},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Indexing and selecting","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\n","type":"content","url":"/notebooks/mpas-advanced#indexing-and-selecting","position":21},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Subset a latitudinal or longitudinal band","lvl3":"Indexing and selecting","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl4","url":"/notebooks/mpas-advanced#subset-a-latitudinal-or-longitudinal-band","position":22},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Subset a latitudinal or longitudinal band","lvl3":"Indexing and selecting","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\n\nuxvar_latitudinal_slice=uxvar.isel(nVertLevels=0).subset.constant_latitude_interval(lats=(int(min_lat+10),int(max_lat-10)))\nplot_lat=hv.operation.contours(\n        uxvar_latitudinal_slice.plot(),filled=True,\n        ).opts(        \n            xlim=(int(min_lon-5),int(max_lon)+5),ylim=(int(min_lat-5),int(max_lat)+5),\n            cmap=\"inferno\",line_color=None, \n            height=500, width=800,        \n            colorbar=True,colorbar_position='bottom'\n            )\n\nuxvar_longitudinal_slice=uxvar.isel(nVertLevels=0).subset.constant_longitude_interval(lons=(int(min_lon+30),int(max_lon-30)))\nplot_lon=hv.operation.contours(\n        uxvar_longitudinal_slice.plot(),filled=True,\n        ).opts(        \n            xlim=(int(min_lon-5),int(max_lon)+5),ylim=(int(min_lat-5),int(max_lat)+5),\n            cmap=\"reds\",line_color=None, \n            height=500, width=800,        \n            colorbar=True,colorbar_position='left'\n            )\n\n\n\n(plot_lat * plot_lon* coast_lines * state_lines).opts(\n        title=\"Latitudinal and Longitudinal Slices of Potential Temperature at Level 0\",\n        shared_axes=True,\n        )\n\n\n\n","type":"content","url":"/notebooks/mpas-advanced#subset-a-latitudinal-or-longitudinal-band","position":23},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Vertical cross section"},"type":"lvl2","url":"/notebooks/mpas-advanced#vertical-cross-section","position":24},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Vertical cross section"},"content":"Based on UXarray, we will generate cross-sections:\n\nalong an arbitrary great‑circle arcs (GCAs) between two point over the sphere surface.\n\nalong a constant longitude line\n\nalong a constant latitude line\n\nWe will also mark the lines or arcs over a map.\n\nHint\n\nWe assume that you have already gone over the previous section, Basic MPAS analysis and visualization with UXarray. If not and if you need to learn about basic indexing, selecting, and generating horizontal figures of variables, we recommend to check that section first.\n\n","type":"content","url":"/notebooks/mpas-advanced#vertical-cross-section","position":25},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Random Great Circle Arc (GCA)","lvl2":"Vertical cross section"},"type":"lvl3","url":"/notebooks/mpas-advanced#random-great-circle-arc-gca","position":26},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Random Great Circle Arc (GCA)","lvl2":"Vertical cross section"},"content":"Let us use UXarray’s vertical cross-section function to get a cross-section over a great circle arc:\n\n%%time\n\nstart_point = (-56.,46.) # (start_lon, start_lat)\nend_point = (-80., 30.) # (end_lon,end_lat)\nstep_between_points = 100\n\ncross_section_gca = uxvar.cross_section(start=start_point, end=end_point, steps=step_between_points)\n\nUXarray’s cross-section returns an xarray.DataArray that can then be plotted:\n\nhlabelticks = [\n    f\"{abs(lat):.1f}°{'N' if lat >= 0 else 'S'}\\n{abs(lon):.1f}°{'E' if lon >= 0 else 'W'}\"\n    for lat, lon in zip(cross_section_gca['lat'], cross_section_gca['lon'])\n]\n\ntick_stride=10\n\ncross_section_gca=cross_section_gca.assign_coords({\n    'steps':cross_section_gca['steps'].values,'nVertLevels':range(cross_section_gca.shape[1])})\n\ncross_section_gca.hvplot.contourf(\n        x='steps',y='nVertLevels', \n        cmap='inferno_r',levels=range(5,300,20),\n        title=\"Cross-section from \"+\n            f\"({abs(start_point[1]):.1f}°{'S' if start_point[1] < 0 else 'N'},{abs(start_point[0]):.1f}°{'W' if start_point[0] < 0 else 'E'})\"+\n            \" to \"+\n            f\"({abs(end_point[1]):.1f}°{'S' if end_point[1] < 0 else 'N'},{abs(end_point[0]):.1f}°{'W' if end_point[0] < 0 else 'E'})\"\n    ).opts(\n    xlabel='steps',\n    xticks=list(zip(cross_section_gca['steps'].values[::tick_stride],hlabelticks[::tick_stride]))\n)\n\n","type":"content","url":"/notebooks/mpas-advanced#random-great-circle-arc-gca","position":27},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Constant Latitude","lvl2":"Vertical cross section"},"type":"lvl3","url":"/notebooks/mpas-advanced#constant-latitude","position":28},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Constant Latitude","lvl2":"Vertical cross section"},"content":"\n\nlat=43.3\nstep_between_points = 400\n\ncross_section_lat = uxvar.cross_section(lat=lat, steps=step_between_points)\n\nhlabelticks = [\n    f\"{abs(lon):.1f}°{'E' if lon >= 0 else 'W'}\" for lon in cross_section_lat['lon']\n]\ntick_stride=10\ncross_section_lat=cross_section_lat.assign_coords({\n    'steps': cross_section_lat['lon'].values,\n    'nVertLevels':range(cross_section_lat.shape[1])})\n\ntick_stride=10\ncross_section_lat.hvplot.contourf(\n        x='steps',y='nVertLevels', \n        cmap='inferno_r',levels=range(5,300,20),\n        title=f\"Cross-section at {abs(lat):.1f}°{'S' if lat < 0 else 'N'}\"\n    ).opts(\n    xlabel='longitudes',\n    xticks=list(zip(cross_section_lat['lon'].values[::tick_stride],hlabelticks[::tick_stride]))\n)\n\n","type":"content","url":"/notebooks/mpas-advanced#constant-latitude","position":29},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Constant Longitude","lvl2":"Vertical cross section"},"type":"lvl3","url":"/notebooks/mpas-advanced#constant-longitude","position":30},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Constant Longitude","lvl2":"Vertical cross section"},"content":"\n\n%%time\nlon=-83.3\nstep_between_points = 400\ncross_section_lon = uxvar.cross_section(lon=lon, steps=step_between_points)\n\nhlabelticks = [\n    f\"{abs(lat):.1f}°{'N' if lat >= 0 else 'S'}\" for lat in cross_section_lon['lat']\n]\n\n# Create labeled coordinates for plotting\ncross_section_lon = cross_section_lon.assign_coords({\n    'steps': cross_section_lon['lat'].values,\n    'nVertLevels': range(cross_section_lon['nVertLevels'].shape[0])\n})\n\ntick_stride=10\ncross_section_lon.hvplot.contourf(\n        x='steps',y='nVertLevels', \n        cmap='inferno_r',levels=range(5,300,20),\n        title=f\"Cross-section at {abs(lon):.1f}°{'W' if lon < 0 else 'E'}\"\n    ).opts(\n    xlabel='latitudes',\n    xticks=list(zip(cross_section_lon['steps'].values[::tick_stride],hlabelticks[::tick_stride]))\n)\n    \n\n","type":"content","url":"/notebooks/mpas-advanced#constant-longitude","position":31},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"type":"lvl3","url":"/notebooks/mpas-advanced#perspective-view-of-cross-sections","position":32},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"content":"\n\n\nimport plotly.graph_objects as go\n\n\n#plotting parameters\ncmap_name='rdbu_r'\ngeography_color='gray'\ncmin,cmax=0,50\n# coordinate parameters\ni_lev=0\n\n\n\n","type":"content","url":"/notebooks/mpas-advanced#perspective-view-of-cross-sections","position":33},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Create geography figures","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"type":"lvl4","url":"/notebooks/mpas-advanced#create-geography-figures","position":34},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Create geography figures","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"content":"\n\n\n# Load shapefiles or use built-in geopandas datasets\nstates = gp.read_file(\"~/.local/share/cartopy/shapefiles/natural_earth/cultural/ne_50m_admin_1_states_provinces_lakes.shp\")\ncoasts = gp.read_file(\"~/.local/share/cartopy/shapefiles/natural_earth/physical/ne_50m_coastline.shp\")  \n\ndef extract_polygon_boundaries(gdf):\n    boundaries = []\n    for geom in gdf.geometry:   \n        if geom.geom_type == 'Polygon':\n            boundaries.append(geom.exterior)\n        elif geom.geom_type == 'MultiPolygon':\n            for poly in geom.geoms: boundaries.append(poly.exterior)\n    return boundaries\n\n\ndef extract_linestring_boundaries(gdf):\n    lines = []\n    for geom in gdf.geometry:\n        if geom.geom_type == 'MultiLineString':\n            for line in geom.geoms:lines.append(line)\n        elif geom.geom_type == 'LineString':\n            lines.append(geom)\n    return lines\n    \ndef make_3d_trace(line,i_lev,min_lat,max_lat,min_lon,max_lon,color='white', width=3):\n    lons, lats= line.xy\n    lons,lats=np.array(lons),np.array(lats)\n    lon_final=lons#[(lons>=min_lon)&(lons<=max_lon)&(lats>=min_lat)&(lons<=max_lat)]\n    lat_final=lats#[(lons>=min_lon)&(lons<=max_lon)&(lats>=min_lat)&(lons<=max_lat)]\n    lev_final=[i_lev]*lon_final.size\n    return go.Scatter3d(x=lon_final, y=lat_final, z=lev_final,mode='lines',line=dict(color=color, width=width),showlegend=False )\n\nboundary_traces = [make_3d_trace(line, i_lev+2,min_lat,max_lat,min_lon,max_lon,color=geography_color) for line in extract_polygon_boundaries(states)]\nboundary_traces = [trace for trace in boundary_traces if not (len(trace['x']) == 0 and len(trace['y']) == 0)]\n\ncoast_traces = [make_3d_trace(line, i_lev+2,min_lat,max_lat,min_lon,max_lon,color=geography_color) for line in extract_linestring_boundaries(coasts)]\ncoast_traces = [trace for trace in coast_traces if not (len(trace['x']) == 0 and len(trace['y']) == 0)]\n\n\n","type":"content","url":"/notebooks/mpas-advanced#create-geography-figures","position":35},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Create horizontal figures and crossections","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"type":"lvl4","url":"/notebooks/mpas-advanced#create-horizontal-figures-and-crossections","position":36},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Create horizontal figures and crossections","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"content":"\n\nuxvar_lev0=uxvar.isel(nVertLevels=i_lev)\nx = uxvar_lev0.uxgrid.face_lon.values  # longitudes\ny = uxvar_lev0.uxgrid.face_lat.values  # latitudes\nz = i_lev+np.zeros_like(x)                 # project onto z=0\nvalues = uxvar_lev0.values.transpose()           # scalar field\n\nhorizontal_figure=go.Scatter3d(\n    name=f'At Level {i_lev:d}',\n    x=x,y=y,z=z,\n    mode='markers',marker=dict(size=3,color=values,colorscale=cmap_name,cmin=cmin,cmax=cmax)\n)\n\n\n# cross-section along a constant longtiude\n\n# coordinate parameters\nlon=-83.3\nstep_between_points = 400\nlong_line_x = [lon, lon]\nlong_line_y = [min_lat, max_lat]\nlong_line_z = [i_lev, i_lev]\n\ncross_section_lon = uxvar.cross_section(lon=lon, steps=step_between_points)\n\nLong_Line=go.Scatter3d(\n    x=long_line_x, y=long_line_y,z=long_line_z,\n    mode='lines',line=dict(color='black', width=12),name='Longitude Line'\n)\n\n# Create labeled coordinates for plotting\ncross_section_lon = cross_section_lon.assign_coords({\n    'steps': cross_section_lon['lat'].values,\n    'nVertLevels': range(cross_section_lon['nVertLevels'].shape[0])\n})\n\n# Get coordinate arrays and create meshgrid\nLAT, LEV = np.meshgrid(cross_section_lon['steps'].values, cross_section_lon['nVertLevels'].values, indexing='ij')  \nLON = lon + np.zeros_like(LAT) \n\n# Flatten for Scatter3d\nx,y,z= LON.flatten(), LAT.flatten(), LEV.flatten()  # flip vertical axis if needed\nvalues = cross_section_lon.values.flatten()\n\n# Mask out NaNs\nmask = ~np.isnan(values)\nx,y,z,values = x[mask],y[mask], z[mask],values[mask]\nconst_lon_figure=go.Scatter3d(\n    name= f\"Along {lon:.1f}°{'E' if lon >= 0 else 'W'}\",\n    x=x,y=y,z=z,mode='markers',opacity=0.8,marker=dict(size=4,color=values,colorscale=cmap_name,cmin=cmin,cmax=cmax)\n)\n\n# cross-section along a constant latitude\n\n\n# coordinate parameters\n\nlat=43.3\nstep_between_points = 400\nlat_line_x = [min_lon, max_lon]\nlat_line_y = [lat-0.5, lat-0.5] # slightly deviate the coordinates to show the line out of the background\nlat_line_z = [i_lev+1, i_lev+1] # slightly deviate the coordinates to show the line out of the background\n\nLati_Line=go.Scatter3d(\n    x=lat_line_x,y=lat_line_y,z=lat_line_z,\n    mode='lines',line=dict(color='black', width=12),name='Latitude Line'\n)\n\ncross_section_lat = uxvar.cross_section(lat=lat, steps=step_between_points)\n\n# Create labeled coordinates for plotting\ncross_section_lat = cross_section_lat.assign_coords({\n    'steps': cross_section_lat['lon'].values,\n    'nVertLevels': range(cross_section_lat['nVertLevels'].shape[0])\n})\n\n# Get coordinate arrays and create meshgrid\nLON, LEV = np.meshgrid(cross_section_lat['steps'].values, cross_section_lat['nVertLevels'].values, indexing='ij')  \nLAT = lat + np.zeros_like(LON) \n\n# Flatten for Scatter3d\nx,y,z= LON.flatten(), LAT.flatten(), LEV.flatten() \nvalues = cross_section_lat.values.flatten()\n\n# Mask out NaNs\nmask = ~np.isnan(values)\nx,y,z,values = x[mask],y[mask], z[mask],values[mask]\n\nconst_lat_figure=go.Scatter3d(\n    name= f\"Along {lat:.1f}°{'N' if lat >= 0 else 'S'}\",\n    x=x,y=y,z=z,mode='markers',marker=dict(size=4,color=values,colorscale=cmap_name,cmin=cmin,cmax=cmax,colorbar=dict(title='Value',len=0.6))\n)\n\n","type":"content","url":"/notebooks/mpas-advanced#create-horizontal-figures-and-crossections","position":37},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Updated the figure","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"type":"lvl4","url":"/notebooks/mpas-advanced#updated-the-figure","position":38},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Updated the figure","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"content":"Use go.Mesh3d to create a smoother cross-section. It will take a bit more time to render.\n\n\n# coordinate parameters\n\nlat=43.3\nstep_between_points = 400\nlat_line_x = [min_lon, max_lon]\nlat_line_y = [lat-0.5, lat-0.5] # slightly deviate the coordinates to show the line out of the background\nlat_line_z = [i_lev+1, i_lev+1] # slightly deviate the coordinates to show the line out of the background\n\nLati_Line=go.Scatter3d(\n    x=lat_line_x,y=lat_line_y,z=lat_line_z,\n    mode='lines',line=dict(color='black', width=12),name='Latitude Line'\n)\n\ncross_section_lat = uxvar.cross_section(lat=lat, steps=step_between_points)\n\n\n\ncross_section_lat = uxvar.cross_section(lat=lat, steps=step_between_points)\n\n# Create labeled coordinates for plotting\ncross_section_lat = cross_section_lat.assign_coords({\n    'steps': cross_section_lat['lon'].values,\n    'nVertLevels': range(cross_section_lat['nVertLevels'].shape[0])\n})\n\n# Get coordinate arrays and create meshgrid\nLON, LEV = np.meshgrid(cross_section_lat['steps'].values, cross_section_lat['nVertLevels'].values, indexing='ij')  \nLAT = lat + np.zeros_like(LON) \n\n# Flatten for Scatter3d\nx,y,z= LON.flatten(), LAT.flatten(), LEV.flatten() \nvalues = cross_section_lat.values.flatten()\n\n# Build triangle indices before masking\nnstep, nlev = len(cross_section_lat['steps']), len(cross_section_lat['nVertLevels'])\ni, j, k = [], [], []\nfor s in range(nstep - 1):\n    for l in range(nlev - 1):\n        idx = s * nlev + l\n        quad = [idx, idx + 1, idx + nlev, idx + nlev + 1]\n        if not np.any(np.isnan(values[quad])):\n            i += [quad[0], quad[1]]\n            j += [quad[1], quad[3]]\n            k += [quad[2], quad[2]]\n\n# Mask points and remap indices\nvalid = ~np.isnan(values)\nx, y, z, values = x[valid], y[valid], z[valid], values[valid]\nremap = {old: new for new, old in enumerate(np.where(valid)[0])}\ni, j, k = [remap[idx] for idx in i], [remap[idx] for idx in j], [remap[idx] for idx in k]\n\n# Add to figure\nconst_lat_figure = go.Mesh3d(\n    name=f\"Along {lat:.1f}°{'N' if lat >= 0 else 'S'}\",\n    x=x, y=y, z=z,i=i, j=j, k=k,intensity=values,\n    colorscale=cmap_name,cmin=cmin, cmax=cmax, colorbar=dict(title='Value', len=0.6),showlegend=True,#showscale=True,    \n    lighting=dict(ambient=1.0),lightposition=dict(x=100, y=200, z=LEV.max()),\n    flatshading=True, opacity=1.0,\n)\n\n\n","type":"content","url":"/notebooks/mpas-advanced#updated-the-figure","position":39},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Select and plot figures","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"type":"lvl4","url":"/notebooks/mpas-advanced#select-and-plot-figures","position":40},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl4":"Select and plot figures","lvl3":"Perspective view of cross-sections","lvl2":"Vertical cross section"},"content":"\n\n\nfig = go.Figure()\nfig.add_trace(horizontal_figure)\n\nfor trace in boundary_traces:fig.add_trace(trace)\nfor trace in coast_traces:fig.add_trace(trace)\n\n# fig.add_trace(const_lon_figure)\n# fig.add_trace(Long_Line)\n\nfig.add_trace(const_lat_figure)\nfig.add_trace(Lati_Line)\n\nxmin,xmax=min_lon-1, max_lon+1\nymin,ymax=min_lat-1, max_lat+5\n\nfig.update_layout(\n    title='UXarray Cross Sections',\n    scene=dict(\n        xaxis_title='Longitude',yaxis_title='Latitude',zaxis_title='Vertical Level',\n        zaxis=dict(range=[LEV.min(),LEV.max()],backgroundcolor=\"rgba(0,0,0,0)\",  gridcolor=\"gray\",    # Grid color for visibility\n                    showbackground=True,zerolinecolor=\"gray\"),\n        xaxis=dict(range=[xmin,xmax],backgroundcolor=\"rgba(0,0,0,0)\",  gridcolor=\"gray\",  \n                    showbackground=True,zerolinecolor=\"gray\"), \n        yaxis=dict(range=[ymin,ymax],backgroundcolor=\"rgba(0,0,0,0)\",  gridcolor=\"gray\",   \n                    showbackground=True,zerolinecolor=\"gray\"),  \n        camera=dict(eye=dict(x=-1.5, y=-3, z=0.4)),\n        aspectmode='manual',\n        aspectratio=dict(x=1., y=2*(ymax-ymin)/(xmax-xmin), z=0.3),  # Compress z-axis\n\n        bgcolor=\"rgba(0,0,0,0)\" # Transparent background for the entire scene\n                     \n    ),\n    width=1000, height=700\n)\n\nfig.show()\n\n\n","type":"content","url":"/notebooks/mpas-advanced#select-and-plot-figures","position":41},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Zonal Average"},"type":"lvl2","url":"/notebooks/mpas-advanced#zonal-average","position":42},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl2":"Zonal Average"},"content":"In this session we use the first level and extract its zonal averages at each latitude, with a bin width of 1°:\n\nuxvar_slice=uxvar.isel(nVertLevels=0)\n\nzonal_mean_uxvar=uxvar_slice.zonal_mean((int(min_lat)+1,int(max_lat), 1))\n\n\n(\n    hv.operation.contours(\n        uxvar_slice.plot(),\n        filled=True,\n        ).opts(        \n        xlim=(int(min_lon-5),int(max_lon)+5),ylim=(int(min_lat-5),int(max_lat)+5),\n        cmap=\"inferno\",line_color=None, \n        height=250, width=500,        \n        colorbar=True,colorbar_position='left'\n            )* coast_lines * state_lines\n    \n    + zonal_mean_uxvar.plot.line(\n        x=\"theta_zonal_mean\",y=\"latitudes\",\n        height=250,width=150,\n        ylabel=\"\",\n        ylim=(int(min_lat-5),int(max_lat)+5),\n        grid=True,\n        )\n    \n    ).opts(\n    title=\"Combined Raster and Zonal Average Plot\",\n    shared_axes=True,\n      )\n\n\n\n\nzonal_mean uses a face-weighted average. It accounts for the area of each grid cell, ensuring that larger cells contribute proportionally more to the mean. This is crucial for MPAS grids, which are unstructured and vary in size.\n\n","type":"content","url":"/notebooks/mpas-advanced#zonal-average","position":43},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Decompose into zonal averages and zonal anomalies","lvl2":"Zonal Average"},"type":"lvl3","url":"/notebooks/mpas-advanced#decompose-into-zonal-averages-and-zonal-anomalies","position":44},{"hierarchy":{"lvl1":"Advanced MPAS Analysis & Visualization with UXarray","lvl3":"Decompose into zonal averages and zonal anomalies","lvl2":"Zonal Average"},"content":"The total field \\theta_{i,j} at any grid could be decomposed into the zonal average, \\bar{\\theta_i}, and the deviations from the zonal average \\theta^\\prime_{i,j}, where i,j represent the latitudinal and longitudinal coordinates, correspondinly.\\theta_{i,j}=\\bar{\\theta_{i}}+\\theta^{\\prime}_{i,j}\n\nWhy this matters?\n\nThe eddy components, or the zonal asymmetrical components, often capture localized variations beyond the zonal mean state. This decomposition is useful when analyzing atmospheric circulation patterns.\n\nWarning\n\nThis method provides a rough check of zonal anomalies by assigning fine-grid values to coarse zonal bins using simple binning logic. It’s useful for quick diagnostics, but it does not yield the accurate zonal anomaly which requires remapping operations. See other notebooks for more references.\n\n# Get latitudes for each face\n\nface_lats = uxvar_slice.uxgrid.face_lat.values  # shape: (n_face,)\n\n#display(zonal_mean_uxvar)\n\nlat_bins = zonal_mean_uxvar['latitudes'] \nlat_bin_indices = np.digitize(face_lats, lat_bins) - 1 \n\n# Clip to valid range\nlat_bin_indices = np.clip(lat_bin_indices, 0, len(lat_bins) - 1)\n\n# Map zonal mean to each face\nzonal_mean_per_face = zonal_mean_uxvar.values[lat_bin_indices]\n\n# Subtract to get anomaly\nuxvar_anomaly = uxvar_slice - zonal_mean_per_face\n(\n    hv.operation.contours(\n        uxvar_anomaly.plot(),\n        filled=True,\n        ).opts(        \n        xlim=(int(min_lon-5),int(max_lon)+5),ylim=(int(min_lat-5),int(max_lat)+5),\n        cmap=\"coolwarm\",line_color=None, \n        height=250, width=500,        \n        colorbar=True,colorbar_position='left'\n            )* coast_lines * state_lines\n    \n    + zonal_mean_uxvar.plot.line(\n        x=\"theta_zonal_mean\",\n        y=\"latitudes\",\n\n        height=250,\n        width=150,\n        ylabel=\"\",\n        ylim=(int(min_lat-5),int(max_lat)+5),\n        grid=True,\n    )\n).opts(\n    title=\"Combined Zonal Anomaly & Zonal Average Plot\",\n      )\n","type":"content","url":"/notebooks/mpas-advanced#decompose-into-zonal-averages-and-zonal-anomalies","position":45},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray"},"type":"lvl1","url":"/notebooks/mpas-basic","position":0},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray"},"content":"","type":"content","url":"/notebooks/mpas-basic","position":1},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"In this section, you’ll learn:"},"type":"lvl3","url":"/notebooks/mpas-basic#in-this-section-youll-learn","position":2},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"In this section, you’ll learn:"},"content":"How to interact with MPAS data: retrieving, subsetting and storing data\n\nHow to visualize horizontal data, i.e. data from a single vertical level","type":"content","url":"/notebooks/mpas-basic#in-this-section-youll-learn","position":3},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Related Documentation"},"type":"lvl3","url":"/notebooks/mpas-basic#related-documentation","position":4},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Related Documentation"},"content":"UxDataset Data Structure\n\n","type":"content","url":"/notebooks/mpas-basic#related-documentation","position":5},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Prerequisites"},"type":"lvl3","url":"/notebooks/mpas-basic#prerequisites","position":6},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Prerequisites"},"content":"Concepts\n\nImportance\n\nUXarray\n\nNecessary\n\nUnstructured Grid\n\nHelpful\n\nTime to learn: 15 minutes\n\n","type":"content","url":"/notebooks/mpas-basic#prerequisites","position":7},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Import packages"},"type":"lvl2","url":"/notebooks/mpas-basic#import-packages","position":8},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Import packages"},"content":"We use Cartopy, GeoViews, Holoviews and Matplotlib packages for visualization. Xarray, UXarray, NumPy and GeoPandas are used for the data structures we use to represent and manipulate the data.\n\n# autoload external python modules if they changed\n%load_ext autoreload\n%autoreload 2\n\n# add ../funcs to the current path\nimport sys, os\nsys.path.append(os.path.join(os.getcwd(), \"..\")) \n\n# import modules\nimport warnings\nimport math\n\nimport cartopy.crs as ccrs\nimport geoviews as gv\nimport geoviews.feature as gf\nimport holoviews as hv\nimport hvplot.xarray\nfrom holoviews import opts\nimport matplotlib.pyplot as plt\n\nimport s3fs\n\nimport geopandas as gp\nimport numpy as np\nimport uxarray as ux\nimport xarray as xr\n\n","type":"content","url":"/notebooks/mpas-basic#import-packages","position":9},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Retrieving the state border lines and coastlines"},"type":"lvl2","url":"/notebooks/mpas-basic#retrieving-the-state-border-lines-and-coastlines","position":10},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Retrieving the state border lines and coastlines"},"content":"\n\ncoast_lines = gf.coastline(projection=ccrs.PlateCarree(), line_width=1, scale=\"50m\")\nstate_lines = gf.states(projection=ccrs.PlateCarree(), line_width=1, line_color='gray', scale=\"50m\")\n\n","type":"content","url":"/notebooks/mpas-basic#retrieving-the-state-border-lines-and-coastlines","position":11},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Helper functions"},"type":"lvl2","url":"/notebooks/mpas-basic#helper-functions","position":12},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Helper functions"},"content":"The following functions are used for visualizing the data. The horizontal_contour function generates the contour map for a given slice of data.\n\n# Generates a contour plot for a horizontal slice\ndef horizontal_contour(ux_hslice, title, cmin=None, cmax=None, width=800, height=500, clevs=20, cmap=\"coolwarm\", symmetric_cmap=False):\n\n    # Get min and max\n    amin = ux_hslice.min().item()\n    amax = ux_hslice.max().item()\n    \n    cmin = math.floor(amin) if(cmin is None) else cmin\n    cmax = math.ceil(amax) if(cmax is None) else cmax\n    \n    if symmetric_cmap:  # get a symmetric color map when cmin < 0, cmax >0\n        cmax = max(abs(cmin), cmax)\n        cmin = -cmax\n\n    if isinstance(cmap, str):\n        cmap = plt.get_cmap(cmap)\n\n    # Generate contour plot\n    title = f\" min={amin:.1f} max={amax:.1f}\"\n    \n    contour_plot = hv.operation.contours(\n        ux_hslice.plot(),\n        levels=np.linspace(cmin, cmax, num=clevs),  # levels=np.arange(cmin, cmax, 0.5)\n        filled=True\n    ).opts(\n        line_color=None,  # line_width=0.001\n        width=width, height=height,\n        cmap='coolwarm', clim=(cmin, cmax),\n        colorbar=True, show_legend=False,\n        tools=['hover'], title=title\n    )\n\n    return contour_plot\n\n","type":"content","url":"/notebooks/mpas-basic#helper-functions","position":13},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl2","url":"/notebooks/mpas-basic#retrieve-load-mpas-jedi-data","position":14},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"The example MPAS/JEDI data are stored at \n\njetstream2. We need to retreive those data first. There are two ways to retrieve MPAS data:\n\nDownload all example data from JetStream2 to local and them load them locally. This approach allows downloading the data once per machine and reuse it in notebooks.\n\nStream the JetStream2 S3 objects on demand. In this case, each notebook (including restarting a notebook) will retrieve the required data separately as needed.\n\n# choose the data_load_method, check the above cell for details. Default to method 2; choose 1 if running from you own machine.\ndata_load_method = 2  # 1 or 2\n\n","type":"content","url":"/notebooks/mpas-basic#retrieve-load-mpas-jedi-data","position":15},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Method 1: Download all example data once and reuse it in mulptile notebooks","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/mpas-basic#method-1-download-all-example-data-once-and-reuse-it-in-mulptile-notebooks","position":16},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Method 1: Download all example data once and reuse it in mulptile notebooks","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\n%%time\nlocal_dir=\"/tmp\"\n\nif data_load_method == 1 and not os.path.exists(local_dir + \"/conus12km/bkg/mpasout.2024-05-06_01.00.00.nc\"):\n    jetstream_url = 'https://js2.jetstream-cloud.org:8001/'\n    fs = s3fs.S3FileSystem(anon=True, asynchronous=False,client_kwargs=dict(endpoint_url=jetstream_url))\n    conus12_path = 's3://pythia/mpas/conus12km'\n    fs.get(conus12_path, local_dir, recursive=True)\n    print(\"Data downloading completed\")\nelse:\n    print(\"Skip..., either data is available in local or data_load_method is NOT 1\")\n\n# Set file path\nif data_load_method == 1:\n    grid_file = local_dir + \"/conus12km/conus12km.invariant.nc_L60_GFS\"\n    ana_file = local_dir + \"/conus12km/bkg/mpasout.2024-05-06_01.00.00.nc\"\n    bkg_file = local_dir + \"/conus12km/ana/mpasout.2024-05-06_01.00.00.nc\"\n    # jdiag_file = local_dir + \"/conus12km/jdiag_aircar_t133.nc\"  #q133.nc or uv233.nc\n\n","type":"content","url":"/notebooks/mpas-basic#method-1-download-all-example-data-once-and-reuse-it-in-mulptile-notebooks","position":17},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Method 2: Stream the JetStream2 S3 objects on demand","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/mpas-basic#method-2-stream-the-jetstream2-s3-objects-on-demand","position":18},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Method 2: Stream the JetStream2 S3 objects on demand","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"\n\n%%time\nif data_load_method == 2:\n    jetstream_url = 'https://js2.jetstream-cloud.org:8001/'\n    fs = s3fs.S3FileSystem(anon=True, asynchronous=False,client_kwargs=dict(endpoint_url=jetstream_url))\n    conus12_path = 's3://pythia/mpas/conus12km'\n    \n    grid_url=f\"{conus12_path}/conus12km.invariant.nc_L60_GFS\"\n    bkg_url=f\"{conus12_path}/bkg/mpasout.2024-05-06_01.00.00.nc\"\n    ana_url=f\"{conus12_path}/ana/mpasout.2024-05-06_01.00.00.nc\"\n    # jdiag_url=f\"{conus12_path}/jdiag_aircar_t133.nc\"\n    \n    grid_file = fs.open(grid_url)\n    ana_file = fs.open(ana_url)\n    bkg_file = fs.open(bkg_url)\n    # jdiag_file = fs.open(jdiag_url)\nelse:\n    print(\"Skip..., data_load_method is NOT 2\")\n\n","type":"content","url":"/notebooks/mpas-basic#method-2-stream-the-jetstream2-s3-objects-on-demand","position":19},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Loading the data into UXarray datasets","lvl2":"Retrieve/load  MPAS/JEDI data"},"type":"lvl3","url":"/notebooks/mpas-basic#loading-the-data-into-uxarray-datasets","position":20},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl3":"Loading the data into UXarray datasets","lvl2":"Retrieve/load  MPAS/JEDI data"},"content":"We use the UXarray data structures to work with the data. This package supports data defined over unstructured grid and provides utilities for modifying and visualizing it. The available functionality are discussed in \n\nUxDataset documentation.\n\nWarning\n\nDepending on the network conditions, loading the data can take a few minutes.\n\nuxds = ux.open_dataset(grid_file, bkg_file)\n\n","type":"content","url":"/notebooks/mpas-basic#loading-the-data-into-uxarray-datasets","position":21},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Regional temperature contour"},"type":"lvl2","url":"/notebooks/mpas-basic#regional-temperature-contour","position":22},{"hierarchy":{"lvl1":"Basic MPAS Analysis & Visualization with UXarray","lvl2":"Regional temperature contour"},"content":"\n\nWe use the theta (potential temperature) variable from this dataset, which has a (Time, n_face, nVertLevels), i.e. Time * Number of grid faces * Number of vertical levels dimensionality to have a look at a regional, horizontal plot.\n\nuxvar = uxds['theta'] - 273.15   ## Kelvin to Celsius\n\nThe data has multiple vertical levels, representing the values for different elevations. In this section, we are focusing on a single level. Next, we are plotting the contour of theta values in the data for this fixed level.\n\ni_lev = 0   # `nVertLevels` index, for picking the 0th level\ni_time = 0  # `Time` index\nlat_val, long_val = 42.63, -83.3 # The latitude and longitude levels we will use in the next section\nlat_line_lims, long_line_lims = [-135, -60], [20, 55] # limits for the cross-section lines\nplot_x_lims, plot_y_lims = (-140, -55), (15,60) # limits for the plot\n\nplot = horizontal_contour(uxvar.isel(Time=0, nVertLevels=i_lev), title=f'Contour plot for potential temperature over a region at vertical level 0') #, symmetric_cmap=True)\nlat_line = hv.Curve((lat_line_lims, [lat_val, lat_val]))\nlong_line = hv.Curve(([long_val, long_val], long_line_lims))\noverlay = (plot * coast_lines * state_lines * lat_line * long_line).redim.range(x=plot_x_lims, y=plot_y_lims)\noverlay.opts(\n    opts.Curve(color='black', line_width=3)\n)\n\nNote\n\nIn the next section, we will work on processing multiple vertical levels via cross-sections. The vertical black lines on the map show the latitude and longitude values we will take the vertical slices over in those exercises.","type":"content","url":"/notebooks/mpas-basic#regional-temperature-contour","position":23},{"hierarchy":{"lvl1":"JEDI Overview"},"type":"lvl1","url":"/notebooks/overview-jedi","position":0},{"hierarchy":{"lvl1":"JEDI Overview"},"content":"","type":"content","url":"/notebooks/overview-jedi","position":1},{"hierarchy":{"lvl1":"JEDI Overview","lvl2":"In this section, you’ll learn:"},"type":"lvl2","url":"/notebooks/overview-jedi#in-this-section-youll-learn","position":2},{"hierarchy":{"lvl1":"JEDI Overview","lvl2":"In this section, you’ll learn:"},"content":"What’s JEDI?","type":"content","url":"/notebooks/overview-jedi#in-this-section-youll-learn","position":3},{"hierarchy":{"lvl1":"JEDI Overview","lvl2":"Related Documentation"},"type":"lvl2","url":"/notebooks/overview-jedi#related-documentation","position":4},{"hierarchy":{"lvl1":"JEDI Overview","lvl2":"Related Documentation"},"content":"JEDI documentation)\n\n","type":"content","url":"/notebooks/overview-jedi#related-documentation","position":5},{"hierarchy":{"lvl1":"JEDI Overview","lvl2":"Prerequisites"},"type":"lvl2","url":"/notebooks/overview-jedi#prerequisites","position":6},{"hierarchy":{"lvl1":"JEDI Overview","lvl2":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\nData Assimilation\n\nHelpful\n\n\n\nJEDI\n\nHelpful\n\n\n\nTime to learn: 5 minutes\n\nThe following introduction is adapted from the JEDI documentation (\n\nhttps://​jointcenterforsatellitedataassimilation​-jedi​-docs​.readthedocs​-hosted​.com​/en​/latest/).\n\nJoint Effort for Data assimilation Integration (JEDI) is a unified and versatile data assimilation (DA) system for Earth System Prediction. The JEDI software package can be run on a variety of platforms from laptops to supercomputers, for a variety of purposes, from teaching and learning DA fundamentals to the development and validation of new DA algorithms and observational operators, to leading-edge atmospheric and oceanic research, to operational weather forecasting. It is designed to readily accommodate new atmospheric and oceanic models and new observation systems.\n\nJEDI is developed and distributed by the Joint Center for Satellite Data Assimilation (JCSDA, \n\nhttps://​www​.jcsda​.org/) , a multi-agency research center hosted by the University Corporation for Atmospheric Research (UCAR, \n\nhttps://​www​.ucar​.edu/). JCSDA is dedicated to improving and accelerating the quantitative use of research and operational satellite data in weather, ocean, climate and environmental analysis and prediction systems.\n\nReaders are recommended to check the above JEDI Documentation for more details.","type":"content","url":"/notebooks/overview-jedi#prerequisites","position":7},{"hierarchy":{"lvl1":"MPAS Overview"},"type":"lvl1","url":"/notebooks/overview-mpas","position":0},{"hierarchy":{"lvl1":"MPAS Overview"},"content":"In this first section of the cookbook, we would like to provide an introduction to \n\nModel for Prediction Across Scales (MPAS). Please note, instead of trying to replicate what has already been made available by the MPAS user and developer community, we will point this this cookrbook’s readers to the right direction to access such resources.\n\n","type":"content","url":"/notebooks/overview-mpas","position":1},{"hierarchy":{"lvl1":"MPAS Overview","lvl3":"In this section, you’ll not code but learn:"},"type":"lvl3","url":"/notebooks/overview-mpas#in-this-section-youll-not-code-but-learn","position":2},{"hierarchy":{"lvl1":"MPAS Overview","lvl3":"In this section, you’ll not code but learn:"},"content":"What is MPAS?\n\nWhy MPAS?","type":"content","url":"/notebooks/overview-mpas#in-this-section-youll-not-code-but-learn","position":3},{"hierarchy":{"lvl1":"MPAS Overview","lvl3":"Related Documentation"},"type":"lvl3","url":"/notebooks/overview-mpas#related-documentation","position":4},{"hierarchy":{"lvl1":"MPAS Overview","lvl3":"Related Documentation"},"content":"MPAS Homepage\n\nMPAS Documentation\n\nMPAS Publications\n\nMPAS Support Forum","type":"content","url":"/notebooks/overview-mpas#related-documentation","position":5},{"hierarchy":{"lvl1":"MPAS Overview","lvl3":"Prerequisites"},"type":"lvl3","url":"/notebooks/overview-mpas#prerequisites","position":6},{"hierarchy":{"lvl1":"MPAS Overview","lvl3":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\nIntroduction to Unstructured Grids\n\nHelpful\n\n\n\nTime to learn: 10 minutes\n\n\n\n","type":"content","url":"/notebooks/overview-mpas#prerequisites","position":7},{"hierarchy":{"lvl1":"MPAS Overview","lvl2":"What is MPAS?"},"type":"lvl2","url":"/notebooks/overview-mpas#what-is-mpas","position":8},{"hierarchy":{"lvl1":"MPAS Overview","lvl2":"What is MPAS?"},"content":"\n\nThe Model for Prediction Across Scales (MPAS) is a collaborative project for developing atmosphere, ocean and other earth-system simulation components for use in climate, regional climate and weather studies.\n\nThe defining features of MPAS are the unstructured \n\nVoronoi meshes and \n\nC-grid discretization used as the basis for many of the model components. The unstructured Voronoi meshes, formally Spherical Centriodal Voronoi Tesselations (SCVTs), allow for both quasi-uniform discretization of the sphere and local refinement. The C-grid discretization, where the normal component of velocity on cell edges is prognosed, is especially well-suited for higher-resolution, mesoscale atmosphere and ocean simulations.\n\nThe land ice model takes advantage of the SCVT-dual mesh, which is a triangular Delaunay tessellation appropriate for use with Finite-Element-based discretizations.\n\nBe sure to check out the \n\nMPAS home page and the References at the end of this section for further details.\n\nImage credit: \n\nhttps://​mpas​-dev​.github​.io​/atmosphere​/atmosphere​.html\n\n","type":"content","url":"/notebooks/overview-mpas#what-is-mpas","position":9},{"hierarchy":{"lvl1":"MPAS Overview","lvl2":"Why MPAS?"},"type":"lvl2","url":"/notebooks/overview-mpas#why-mpas","position":10},{"hierarchy":{"lvl1":"MPAS Overview","lvl2":"Why MPAS?"},"content":"\n\nThe key features of MPAS are:\n\nSuitability for global and regional analysis\n\nApplicability to weather and climate research\n\nVariable resolution\n\nScalability\n\n","type":"content","url":"/notebooks/overview-mpas#why-mpas","position":11},{"hierarchy":{"lvl1":"MPAS Overview","lvl2":"References"},"type":"lvl2","url":"/notebooks/overview-mpas#references","position":12},{"hierarchy":{"lvl1":"MPAS Overview","lvl2":"References"},"content":"MPAS Mesh Specification Version 1.0, 2015\n\n","type":"content","url":"/notebooks/overview-mpas#references","position":13},{"hierarchy":{"lvl1":"MPAS Overview","lvl2":"What is next?"},"type":"lvl2","url":"/notebooks/overview-mpas#what-is-next","position":14},{"hierarchy":{"lvl1":"MPAS Overview","lvl2":"What is next?"},"content":"The \n\nnext section will provide an overview of the The Joint Effort for Data assimilation (JEDI).","type":"content","url":"/notebooks/overview-mpas#what-is-next","position":15},{"hierarchy":{"lvl1":"RRFSv2 Overview"},"type":"lvl1","url":"/notebooks/overview-rrfsv2","position":0},{"hierarchy":{"lvl1":"RRFSv2 Overview"},"content":"","type":"content","url":"/notebooks/overview-rrfsv2","position":1},{"hierarchy":{"lvl1":"RRFSv2 Overview","lvl2":"In this section, you’ll learn:"},"type":"lvl2","url":"/notebooks/overview-rrfsv2#in-this-section-youll-learn","position":2},{"hierarchy":{"lvl1":"RRFSv2 Overview","lvl2":"In this section, you’ll learn:"},"content":"What’s RRFS(v2)?\n\nWhat’s RDASApp?\n\nWhat’s rrfs-workflow?","type":"content","url":"/notebooks/overview-rrfsv2#in-this-section-youll-learn","position":3},{"hierarchy":{"lvl1":"RRFSv2 Overview","lvl2":"Related Documentation"},"type":"lvl2","url":"/notebooks/overview-rrfsv2#related-documentation","position":4},{"hierarchy":{"lvl1":"RRFSv2 Overview","lvl2":"Related Documentation"},"content":"rrfs-workflow\n\nRDASApp\n\nrrfs-workflow in depth (slides)(request access if you are not able to view the slides)","type":"content","url":"/notebooks/overview-rrfsv2#related-documentation","position":5},{"hierarchy":{"lvl1":"RRFSv2 Overview","lvl2":"Prerequisites"},"type":"lvl2","url":"/notebooks/overview-rrfsv2#prerequisites","position":6},{"hierarchy":{"lvl1":"RRFSv2 Overview","lvl2":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\ndata assimilation\n\nHelpful\n\n\n\nResearch to Operation\n\nHelpful\n\n\n\nTime to learn: 5 minutes\n\nNOAA has been developing the Rapid Refresh Forecast System (RRFS) to provide high-resolution, rapidly updating weather forecasts. The first version of RRFS is built on \n\nthe FV3 model) and the Gridpoint Statistical Interpolation (GSI) data assimilation system (\n\nGSI info). The next-generation RRFS, known as RRFSv2, adopts the MPAS model and the JEDI data assimilation framework. Development of RRFSv2 is a collaborative effort between NOAA’s Global Systems Laboratory (\n\nGSL) and NOAA’s Environmental Modeling Center (\n\nEMC), with the goal of operational deployment around 2028 or 2029.\n\nRRFSv2 convers a regional domain with a special resolution of around 3km. The MPAS model has being enhanced with GSL/UFS physics (\n\nlink to the UFS MPAS) to improve forecast performance. To support RRFSv2’s unique requirements, a specialized proxy application—\n\nRDASApp—has been developed. RDASApp configures and integrates JEDI components, providing the executables and tools needed to perform RRFSv2 data assimilation cycles.\n\nTo streamline reasearh and development testing as well as operational implmentation, an operation-oriented, community flexible end-to-end workflow, \n\nrrfs-workflow has been developed. rrfs-workflow enables both real-time and restrospective RRFSv2 experiments, accelerating the Research to Operation (R2O) transition and fostering collaborations between research and operation.","type":"content","url":"/notebooks/overview-rrfsv2#prerequisites","position":7}]}